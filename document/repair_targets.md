# FinViz Python API 修复目标文档

## 修复范围说明

根据项目需求，我们专注于修复以下两个核心功能模块：
1. **股票数据获取功能** - 获取单个股票的详细数据
2. **股票筛选器功能** - 从FinViz筛选器获取股票列表数据

**不修复的功能**：
- 投资组合管理功能
- 图表下载功能  
- CSV/SQLite文件导出功能
- 其他文件操作相关功能

**目标**：为MCP集成准备，所有功能返回标准化的JSON格式数据。

---

## 1. 股票数据获取功能修复目标

### 1.1 get_stock(ticker) 功能
**当前状态**: ❌ **完全失效**
- **错误**: `IndexError: list index out of range`
- **错误位置**: `main_func.py:35` - `title = page_parsed.cssselect('table[class="fullview-title"]')[0]`
- **根本原因**: FinViz网站结构变化，CSS选择器 `'table[class="fullview-title"]'` 无法找到对应元素
- **影响**: 无法获取任何股票基本信息

**修复目标**:
- 更新CSS选择器适配新的网页结构
- 确保能获取完整的股票数据（价格、市值、P/E比、财务数据等）
- 返回标准化的JSON格式数据
- 添加错误处理机制

### 1.2 get_news(ticker) 功能
**当前状态**: ❌ **时间解析失败**
- **错误**: `ValueError: time data '\n            Today 06:00AM\n      ' does not match format '%b-%d-%y %I:%M%p'`
- **错误位置**: `main_func.py:113` - 时间格式解析错误
- **根本原因**: 网页时间格式从 `'%b-%d-%y %I:%M%p'` 变为 `'Today 06:00AM'` 格式
- **影响**: 无法正确解析新闻时间戳，导致新闻数据获取失败

**修复目标**:
- 支持多种时间格式解析（包括新的"Today XX:XXAM/PM"格式）
- 实现时间格式自动检测和转换
- 确保能获取完整的新闻数据（标题、链接、时间、来源等）
- 返回标准化的JSON格式数据

### 1.3 get_insider(ticker) 功能
**当前状态**: ⚠️ **部分可用但无数据**
- **实际结果**: 函数执行成功，返回空列表 `[]`
- **根本原因**: 可能由于网页结构变化或没有内部交易数据而返回空结果
- **影响**: 功能可用但无实际数据返回

**修复目标**:
- 检查网页结构变化，更新数据提取逻辑
- 添加数据存在性验证
- 确保有数据时能正确返回内部交易信息
- 返回标准化的JSON格式数据

### 1.4 get_analyst_price_targets(ticker) 功能
**当前状态**: ⚠️ **部分可用但无数据**
- **实际结果**: 函数执行成功，返回空列表 `[]`
- **根本原因**: 可能由于网页结构变化或没有分析师数据而返回空结果
- **影响**: 功能可用但无实际数据返回

**修复目标**:
- 检查网页结构变化，更新数据提取逻辑
- 添加数据存在性验证
- 确保有数据时能正确返回分析师价格目标信息
- 返回标准化的JSON格式数据

### 1.5 get_all_news() 功能
**当前状态**: ⚠️ **部分可用但无数据**
- **实际结果**: 函数执行成功，返回空列表 `[]`
- **根本原因**: 可能由于网页结构变化导致新闻数据无法正确解析
- **影响**: 功能可用但无实际数据返回

**修复目标**:
- 检查网页结构变化，更新数据提取逻辑
- 添加数据存在性验证
- 确保能正确返回所有新闻数据
- 返回标准化的JSON格式数据

---

## 2. 股票筛选器功能修复目标

### 2.1 筛选器基本创建功能
**当前状态**: ✅ **正常**
- **测试结果**: 筛选器对象创建成功，能够设置筛选条件和行数限制
- **状态**: 无需修复

### 2.2 筛选器数据获取功能
**当前状态**: ⚠️ **表头解析失败**
- **问题**: 能够获取数据列表，但表头为空 `[]`
- **根本原因**: 网页结构变化导致表头解析失败
- **影响**: 数据行数正确，但内容可能不完整，无法知道每列数据的含义

**修复目标**:
- 分析筛选器页面结构变化
- 更新表头提取逻辑
- 确保表头和数据行正确对应
- 返回包含表头信息的完整数据结构

### 2.3 筛选器URL初始化功能
**当前状态**: ⚠️ **URL解析正常但数据解析有问题**
- **问题**: URL初始化成功，但表头为空，数据解析不完整
- **根本原因**: URL解析正常，但数据解析逻辑有问题
- **影响**: 能创建筛选器但数据不完整

**修复目标**:
- 修复数据解析逻辑
- 确保URL初始化的筛选器能返回完整数据
- 保持URL解析功能的稳定性

### 2.4 筛选器过滤器字典加载功能
**当前状态**: ❌ **完全失效**
- **错误**: `AttributeError: 'NoneType' object has no attribute 'get'`
- **错误位置**: `screener.py:277` - `filter_name = selections.get("data-filter").strip()`
- **根本原因**: 网页结构变化导致筛选器选项无法正确解析，`selections` 为 `None`
- **影响**: 无法获取可用的筛选器选项

**修复目标**:
- 分析筛选器选项页面的新结构
- 更新筛选器选项解析逻辑
- 确保能正确加载所有可用的筛选器选项
- 返回标准化的筛选器选项JSON数据

---

## 3. 辅助功能修复目标

### 3.1 HTTP请求功能
**当前状态**: ✅ **正常**
- **测试结果**: HTTP请求功能正常，能够成功连接到FinViz网站
- **状态**: 无需修复

### 3.2 异步连接器功能
**当前状态**: ❌ **处理函数类型错误**
- **错误**: `AttributeError: 'bytes' object has no attribute 'text'`
- **根本原因**: 异步连接器返回的是bytes对象，但测试代码期望的是Response对象
- **影响**: 异步连接器功能需要正确的处理函数

**修复目标**:
- 修复异步连接器的处理函数
- 确保异步请求能正确返回数据
- 为MCP集成提供高效的异步数据获取能力

### 3.3 数据保存功能
**当前状态**: ✅ **正常**
- **测试结果**: CSV和SQLite保存功能正常
- **状态**: 由于MCP集成不需要文件操作，此功能将被移除

### 3.4 错误处理功能
**当前状态**: ✅ **正常**
- **测试结果**: 异常类定义正确，能够正常导入和使用
- **状态**: 无需修复，但需要增强

**修复目标**:
- 增强错误处理机制
- 添加更详细的错误信息
- 为MCP集成提供标准化的错误响应格式

---

## 4. 修复优先级总结

### 🔥 高优先级（核心功能）
1. **get_stock功能** - 完全失效，影响基础股票数据获取
2. **get_news功能** - 时间解析失败，影响新闻数据获取
3. **筛选器表头解析** - 影响筛选器数据完整性
4. **筛选器过滤器字典加载** - 完全失效，影响筛选器选项获取

### 🔧 中优先级（数据完整性）
1. **get_insider功能** - 无数据返回，需要检查网页结构
2. **get_analyst_price_targets功能** - 无数据返回，需要检查网页结构
3. **get_all_news功能** - 无数据返回，需要检查网页结构
4. **筛选器数据解析** - 数据解析不完整

### 🚀 低优先级（优化和集成准备）
1. **异步连接器功能** - 处理函数类型错误
2. **错误处理增强** - 为MCP集成提供更好的错误处理
3. **JSON格式标准化** - 统一所有函数的返回格式
4. **代码清理** - 移除不需要的文件操作功能

---

## 5. 预期修复结果

修复完成后，核心功能应该能够：

### 股票数据获取功能
- ✅ `get_stock('AAPL')` 返回完整的股票数据JSON
- ✅ `get_news('AAPL')` 返回完整的新闻数据JSON
- ✅ `get_insider('AAPL')` 返回内部交易数据JSON（如果有数据）
- ✅ `get_analyst_price_targets('AAPL')` 返回分析师数据JSON（如果有数据）
- ✅ `get_all_news()` 返回所有新闻数据JSON

### 股票筛选器功能
- ✅ `Screener(filters=['idx_sp500'], rows=5)` 返回完整的筛选器数据JSON
- ✅ `Screener.init_from_url(url)` 返回完整的筛选器数据JSON
- ✅ `Screener.load_filter_dict()` 返回可用的筛选器选项JSON

### 通用要求
- ✅ 所有函数返回标准化的JSON格式
- ✅ 完善的错误处理和错误信息
- ✅ 为MCP集成优化的代码结构
- ✅ 移除不需要的文件操作功能

---

*本文档将随着修复进展持续更新*
